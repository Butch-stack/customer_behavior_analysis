SELECT COUNT(*) FROM customer_shopping_behavior;

-- Q1. What is the total revenue generated by male vs. female customers?

SELECT gender, SUM(purchase_amount_usd) AS revenue
FROM customer_shopping_behavior
GROUP BY gender;

-- Q2. Which customers used a discount but still spent more than the average purchase amount?

select customer_id, purchase_amount_usd 
from customer_shopping_behavior
where discount_applied = 'Yes' and purchase_amount_usd >= (select AVG(purchase_amount_usd) from  customer_shopping_behavior);

-- Q3. Which are the top 5 products with the highest average revenue ratings?

select item_purchased, round(AVG(review_rating),2) as "Average Product Rating"
from customer_shopping_behavior
group by item_purchased
order by avg(review_rating) desc
limit 5;

-- Q4. Compare the average purchase amounts between Standard and Express Shipping.

select shipping_type,
round(avg(purchase_amount_usd),2)
from customer_shopping_behavior
where shipping_type in ('Standard','Express')
group by shipping_type;

-- Q5. Do subscribed customers spend more? Compare average spend and total revenue between subscribers and non-subscribers.

select subscription_status,
count(customer_id) as total_customers,
round(avg(purchase_amount_usd),2) as avg_spend,
round(sum(purchase_amount_usd),2) as total_revenue
from customer_shopping_behavior
group by subscription_status
order by total_revenue, avg_spend desc;

-- Q6. Which 5 products have the highest percentage of purchases with discounts applied?

select item_purchased,
round(100.0 * sum(case when discount_applied = 'Yes' then 1 else 0 end)/count(*),2) 
as discount_rate
from customer_shopping_behavior
group by item_purchased
order by round(100.0 * sum(case when discount_applied = 'Yes' then 1 else 0 end)/count(*),2)  desc
limit 5;

-- Q7. Segment customers into New, Returning, and Loyal based on their total number of previous purchases, and show the count of each segment.

WITH customer_type AS (
    SELECT customer_id, previous_purchases,
           CASE
               WHEN previous_purchases = 1 THEN 'New'
               WHEN previous_purchases BETWEEN 2 AND 10 THEN 'Returning'
               ELSE 'Loyal'
           END AS customer_segment
    FROM customer_shopping_behavior
)

SELECT customer_segment,
       COUNT(*) AS `Number of Customers`
FROM customer_type
GROUP BY customer_segment;

-- Q8. What are the top 3 most purchased products within each category?

with item_counts as (
select category,
item_purchased,
count(customer_id) as total_orders,
ROW_NUMBER() over (partition by category order by count(customer_id)DESC) as item_rank
from customer_shopping_behavior
group by category, item_purchased
)

select item_rank, item_purchased, total_orders
from item_counts
where item_rank <= 3;

-- Q9. Are customers who are repeat buyers (more than 5 previous purchases) also likely to subscribe?

select subscription_status,
count(customer_id) as repaeat_buyers
from customer_shopping_behavior
where previous_purchases > 5
group by subscription_status;

-- Q10. What is the revenue contribution of each age group?

SELECT age_group, SUM(purchase_amount_usd) AS total_revenue
FROM (
    SELECT
        CASE
            WHEN age < 18 THEN 'Under 18'
            WHEN age BETWEEN 18 AND 25 THEN 'Young Adult'
            WHEN age BETWEEN 26 AND 40 THEN 'Adult'
            WHEN age BETWEEN 41 AND 60 THEN 'Middle-aged'
            ELSE 'Senior'
        END AS age_group,
        purchase_amount_usd
    FROM customer_shopping_behavior
) t
GROUP BY age_group
ORDER BY total_revenue DESC;
-- t is subquery